# Security Policy and Dependency Scanning Workflow
name: Dependency Review & Security

on:
  push:
    branches: [main]
    paths:
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'setup.py'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  security-events: write

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        continue-on-error: true
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

      - name: Note about Dependency Review support
        if: always()
        run: |
          echo "Dependency Review requires GitHub Dependency Graph (and on some plans, Advanced Security)."
          echo "If this repository does not support it, the step is allowed to fail without blocking PRs."

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit
        continue-on-error: true

      - name: Run pip-audit
        run: |
          pip install -r requirements.txt || true
          pip-audit --desc on --fix --dry-run || true
        continue-on-error: true

      - name: Run Safety check
        run: |
          safety check -r requirements.txt --full-report || true
        continue-on-error: true
